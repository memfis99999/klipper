# Perform continuous integration tests on updates and pull requests
name: Build Firmware

concurrency:
  group: build-firmware-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

on:
  workflow_run:
    workflows: ["Build test"]
    types: [completed]

  # Возможность ручного запуска из интерфейса GitHub
  workflow_dispatch:
    inputs:
      force_notify:
        description: 'Force Telegram notification'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Fetch tags (required for git describe)
        shell: bash
        run: |
          set -euo pipefail
          git fetch --force --tags origin
          git describe --tags --long --dirty --always || true
          echo "Tags count: $(git tag | wc -l)"

      - name: Setup cache
        uses: actions/cache@v3
        with:
          path: ci_cache
          key: ${{ runner.os }}-build-${{ hashFiles('scripts/ci-install.sh') }}

      - name: Check if build script exists
        id: check_script
        shell: bash
        run: |
          if [ ! -f "./scripts/ci-build_creality.sh" ]; then
            echo "missing_script=true" >> "$GITHUB_OUTPUT"
          else
            echo "missing_script=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify missing script
        if: steps.check_script.outputs.missing_script == 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        shell: bash
        run: |
          MESSAGE="Repository: ${REPO}%0ABranch: ${BRANCH}%0AWorkflow: ${WORKFLOW}%0AStatus: BUILD SCRIPT MISSING (./scripts/ci-build_creality.sh)%0ARun: ${RUN_URL}"
          if [ -n "${TELEGRAM_TOPIC_ID:-}" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d message_thread_id="${TELEGRAM_TOPIC_ID}" \
              -d text="${MESSAGE}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${MESSAGE}"
          fi

      - name: Prepare build environment
        if: steps.check_script.outputs.missing_script == 'false'
        run: ./scripts/ci-install.sh

      - name: Build firmware
        if: steps.check_script.outputs.missing_script == 'false'
        shell: bash
        run: |
          chmod +x ./scripts/ci-build_creality.sh
          ./scripts/ci-build_creality.sh

      - name: Upload firmware
        if: steps.check_script.outputs.missing_script == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: output/

      - name: Push firmware to fw-files branch
        if: steps.check_script.outputs.missing_script == 'false'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git ls-remote --exit-code origin fw-files || git branch fw-files
          git fetch origin fw-files || true
          git worktree add fw-worktree fw-files
          rm -rf fw-worktree/fw/K1
          mkdir -p fw-worktree/fw/K1
          cp -r output/* fw-worktree/fw/K1/
          cd fw-worktree
          git add fw
          git commit -m "FW for ${GITHUB_SHA}" || true
          git push origin fw-files
          cd ..
          git worktree remove fw-worktree --force

      - name: Notify success
        if: steps.check_script.outputs.missing_script == 'false' && success()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        shell: bash
        run: |
          MESSAGE="Repository: ${REPO}%0ABranch: ${BRANCH}%0AWorkflow: ${WORKFLOW}%0AStatus: FIRMWARE BUILT%0ARun: ${RUN_URL}"
          if [ -n "${TELEGRAM_TOPIC_ID:-}" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d message_thread_id="${TELEGRAM_TOPIC_ID}" \
              -d text="${MESSAGE}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${MESSAGE}"
          fi

      - name: Notify failure
        if: steps.check_script.outputs.missing_script == 'false' && failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        shell: bash
        run: |
          MESSAGE="Repository: ${REPO}%0ABranch: ${BRANCH}%0AWorkflow: ${WORKFLOW}%0AStatus: FIRMWARE BUILD FAILED%0ARun: ${RUN_URL}"
          if [ -n "${TELEGRAM_TOPIC_ID:-}" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d message_thread_id="${TELEGRAM_TOPIC_ID}" \
              -d text="${MESSAGE}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${MESSAGE}"
          fi
